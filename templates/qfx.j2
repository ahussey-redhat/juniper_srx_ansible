{# configure global settings #}
set system host-name {{ host_name }}
{% for name_server in system_name_servers %}
set system name-server {{ name_server }}
{% endfor %}
{# set chassis auto-image-upgrade #}

{# configure virtual chassis #}
set virtual-chassis preprovisioned
{% for chassis in qfx_chassis %}
set virtual-chassis member {{ chassis.member }} serial-number {{ chassis.serial }} role routing-engine
{% endfor %}
set virtual-chassis no-split-detection

delete vlans
{#
delete routing-instances
delete policy-options
#}
{# configure vlans #}
{% for subnet in subnets %}
set vlans {{ subnet.vlan.tag }} vlan-id {{ subnet.vlan.id }}
{#
set vlans {{ subnet.vlan.tag }} l3-interface {{ subnet.vlan.l3_interface }}
set interfaces irb unit {{ subnet.vlan.id }} family inet address {{ subnet.last_ip }}/{{ subnet.mask }}
{#
set routing-instances {{ subnet.vlan.tag }} interface {{ subnet.vlan.l3_interface }}
set routing-instances {{ subnet.vlan.tag }} instance-type virtual-router
set routing-instances {{ subnet.vlan.tag }} forwarding-options dhcp-relay server-group {{ subnet.vlan.tag }} {{ subnet.gateway }}
set routing-instances {{ subnet.vlan.tag }} forwarding-options dhcp-relay group {{ subnet.vlan.tag }} active-server-group {{ subnet.vlan.tag }}

set routing-instances {{ subnet.vlan.tag }} forwarding-options dhcp-relay group {{ subnet.vlan.tag }} interface {{ subnet.vlan.l3_interface }}
set routing-instances {{ subnet.vlan.tag }} forwarding-options dhcp-relay group {{ subnet.vlan.tag }} overrides
set routing-instances {{ subnet.vlan.tag }} forwarding-options dhcp-relay group {{ subnet.vlan.tag }} relay-option option-number 60
set routing-instances {{ subnet.vlan.tag }} routing-options static route 0.0.0.0/0 next-hop {{ subnet.gateway }}
set routing-instances {{ subnet.vlan.tag }} routing-options interface-routes rib-group inet {{ subnet.vlan.tag }}

set routing-options rib-groups {{ subnet.vlan.tag }} import-rib {{ subnet.vlan.tag }}.inet.0
{% set count = namespace(value=0) %}
{% for rib in subnet.allowed_ribs %}
set policy-options policy-statement allowed-from-{{ subnet.vlan.tag }} term t{{count.value}} from instance {{ rib }}
set policy-options policy-statement allowed-from-{{ subnet.vlan.tag }} term t{{count.value}} then accept
set routing-options rib-groups {{ subnet.vlan.tag }} import-rib {{ rib }}.inet.0
{% set count.value = count.value +1 %}
{% endfor %}
#}
{% endfor %}

{#
    Configure aggregated ethernet interfaces to connect to SRX cluster.
    The number of aggregated devices inlcudes both uplink and host devices.
#}
set chassis aggregated-devices ethernet device-count 6

{% for interface in aggregated_ethernet_interfaces %}
set interfaces {{ interface.name }} unit 0 family ethernet-switching interface-mode trunk
set interfaces {{ interface.name }} vlan-tagging
set interfaces {{ interface.name }} native-vlan-id 1
set interfaces {{ interface.name }} aggregated-ether-options lacp active
set interfaces {{ interface.name }} aggregated-ether-options lacp periodic slow
set interfaces {{ interface.name }} gratuitous-arp-reply
set protocols rstp interface {{ interface.name }}
{% for member in interface.members %}
set interfaces {{ member }} ether-options 802.3ad {{ interface.name }}
{% endfor %}
{% for subnet in subnets %}
set interfaces {{ interface.name }} unit 0 family ethernet-switching vlan members {{ subnet.vlan.tag }}
{% endfor %}

{% endfor %}

set protocols l2-learning global-mac-table-aging-time 120
set protocols lldp interface all
set protocols lldp-med interface all
set protocols igmp-snooping vlan default

{# configure LAN interfaces #}
{% for interface in lan_interfaces %}
set interfaces {{ interface.name }} gratuitous-arp-reply
{% if interface.rstp | default(false) %}
set protocols rstp interface {{ interface.name }}
{% endif %}
{% if 'ae' in interface.name %}
set interfaces {{ interface.name }} aggregated-ether-options lacp active
set interfaces {{ interface.name }} aggregated-ether-options lacp periodic slow
{% for member in interface.members %}
set interfaces {{ member }} ether-options 802.3ad {{ interface.name }}
{% endfor %}
{% endif %}
{% if interface.vlans is defined %}
set interfaces {{ interface.name }} unit 0 family ethernet-switching interface-mode trunk
set interfaces {{ interface.name }} vlan-tagging
set interfaces {{ interface.name }} native-vlan-id {{ interface.native_vlan_id | default(1) }}
{% for vlan in interface.vlans %}
{% for subnet in subnets %}
{% if vlan == subnet.vlan.id %}
set interfaces {{ interface.name }} unit 0 family ethernet-switching vlan members {{ subnet.vlan.tag }}
{% endif %}
{% endfor %}
{% endfor %}
{% endif %}

{% endfor %}
